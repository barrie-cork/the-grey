{% extends "base.html" %}
{% load static %}

{% block title %}Processing Status - {{ session.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'results_manager/css/processing_status.css' %}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Processing Status</h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'review_manager:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'review_manager:session_detail' session.id %}">{{ session.title }}</a></li>
                        <li class="breadcrumb-item active">Processing</li>
                    </ol>
                </nav>
            </div>

            <!-- Session Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ session.title }}</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>Processing Status:</strong> 
                                <span class="badge badge-{% if processing_session.status == 'completed' %}success{% elif processing_session.status == 'failed' %}danger{% elif processing_session.status == 'in_progress' %}primary{% else %}secondary{% endif %}">
                                    {{ processing_session.get_status_display|default:'Unknown' }}
                                </span>
                            </p>
                            {% if processing_session.started_at %}
                            <p class="mb-1"><strong>Started:</strong> {{ processing_session.started_at|date:"M d, Y H:i" }}</p>
                            {% endif %}
                            {% if processing_time %}
                            <p class="mb-1"><strong>Duration:</strong> {{ processing_time }} seconds</p>
                            {% endif %}
                        </div>
                        <div class="col-md-6 text-right">
                            <a href="{% url 'results_manager:results_overview' session.id %}" class="btn btn-success">
                                <i class="fas fa-list"></i> View Results
                            </a>
                            {% if can_retry %}
                            <form method="post" action="{% url 'results_manager:start_processing' session.id %}" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-redo"></i> Retry Processing
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overall Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Overall Progress</h5>
                </div>
                <div class="card-body">
                    <div class="progress-container mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="progress-label">
                                {{ processing_session.progress_percentage }}% 
                                ({{ processing_session.processed_count }}/{{ processing_session.total_raw_results }} results)
                            </span>
                            {% if estimated_completion %}
                            <small class="text-muted">
                                Estimated completion: {{ estimated_completion|date:"H:i" }}
                            </small>
                            {% endif %}
                        </div>
                        <div class="progress progress-lg">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: {{ processing_session.progress_percentage }}%"
                                 aria-valuenow="{{ processing_session.progress_percentage }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>

                    {% if processing_session.current_stage %}
                    <div class="current-stage-info">
                        <h6>Current Stage: {{ processing_session.get_current_stage_display|default:processing_session.current_stage|title }}</h6>
                        <div class="progress progress-sm mb-3">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {{ processing_session.stage_progress }}%"
                                 aria-valuenow="{{ processing_session.stage_progress }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                                {{ processing_session.stage_progress }}% complete
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Processing Stages -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Processing Stages</h5>
                </div>
                <div class="card-body">
                    {% for stage in stage_info %}
                    <div class="stage-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div class="stage-info">
                                <span class="stage-icon">{{ stage.icon }}</span>
                                <span class="stage-name">{{ stage.name }}</span>
                                <span class="badge badge-{% if stage.status == 'completed' %}success{% elif stage.status == 'in_progress' %}primary{% else %}secondary{% endif %} ml-2">
                                    {{ stage.status|title }}
                                </span>
                            </div>
                            <span class="stage-progress-text">{{ stage.progress }}%</span>
                        </div>
                        <div class="progress progress-sm">
                            <div class="progress-bar 
                                        {% if stage.status == 'completed' %}bg-success
                                        {% elif stage.status == 'in_progress' %}bg-primary
                                        {% else %}bg-light{% endif %}" 
                                 role="progressbar" 
                                 style="width: {{ stage.progress }}%"
                                 aria-valuenow="{{ stage.progress }}" 
                                 aria-valuemin="0" aria-valuemax="100">
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ processing_session.duplicate_count|default:0 }}</div>
                                <div class="stat-label">Duplicates Found</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ processing_session.error_count|default:0 }}</div>
                                <div class="stat-label">Processing Errors</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ processing_session.processed_count|default:0 }}</div>
                                <div class="stat-label">Results Processed</div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <div class="stat-number">{{ processing_session.total_raw_results|default:0 }}</div>
                                <div class="stat-label">Total Raw Results</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Errors -->
            {% if recent_errors %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Recent Errors</h5>
                </div>
                <div class="card-body">
                    {% for error in recent_errors %}
                    <div class="error-item mb-3 p-3 border-left border-danger">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="text-danger mb-1">{{ error.message }}</h6>
                                {% if error.details %}
                                <small class="text-muted">
                                    {% for key, value in error.details.items %}
                                    <strong>{{ key|title }}:</strong> {{ value }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                </small>
                                {% endif %}
                            </div>
                            <small class="text-muted">{{ error.timestamp|date:"M d, H:i" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="card">
                <div class="card-body text-center">
                    {% if can_cancel %}
                    <button type="button" class="btn btn-warning" onclick="pauseProcessing()">
                        <i class="fas fa-pause"></i> Pause
                    </button>
                    {% endif %}
                    
                    {% if processing_session.error_count > 0 %}
                    <button type="button" class="btn btn-info" onclick="viewAllErrors()">
                        <i class="fas fa-exclamation-triangle"></i> View All Errors
                    </button>
                    {% endif %}
                    
                    {% if can_cancel %}
                    <button type="button" class="btn btn-danger" onclick="cancelProcessing()">
                        <i class="fas fa-stop"></i> Cancel
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Auto-refresh notification -->
{% if processing_session.status == 'in_progress' %}
<div class="auto-refresh-indicator">
    <small class="text-muted">
        <i class="fas fa-sync-alt fa-spin"></i> Auto-refreshing every 5 seconds
    </small>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'results_manager/js/processing_status.js' %}"></script>
<script>
// Real-time updates for processing status
let refreshInterval;
const sessionId = '{{ session.id }}';
const processingStatus = '{{ processing_session.status }}';

document.addEventListener('DOMContentLoaded', function() {
    // Start auto-refresh if processing is in progress
    if (processingStatus === 'in_progress') {
        startAutoRefresh();
    }
});

function startAutoRefresh() {
    refreshInterval = setInterval(function() {
        fetchProcessingStatus();
    }, 5000); // Refresh every 5 seconds
}

function stopAutoRefresh() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
        refreshInterval = null;
    }
}

async function fetchProcessingStatus() {
    try {
        const response = await fetch(`/results-manager/api/processing-status/${sessionId}/`, {
            headers: {
                'Authorization': `Token ${getAuthToken()}`,
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            updateProcessingUI(data);
            
            // Stop auto-refresh if processing completed
            if (data.status !== 'in_progress') {
                stopAutoRefresh();
                // Optionally redirect to results page
                if (data.status === 'completed') {
                    setTimeout(() => {
                        window.location.href = `{% url 'results_manager:results_overview' session.id %}`;
                    }, 2000);
                }
            }
        }
    } catch (error) {
        console.error('Error fetching processing status:', error);
        stopAutoRefresh();
    }
}

function updateProcessingUI(data) {
    // Update progress bars
    const overallProgress = document.querySelector('.progress-bar.bg-primary');
    if (overallProgress) {
        overallProgress.style.width = `${data.progress_percentage}%`;
        overallProgress.setAttribute('aria-valuenow', data.progress_percentage);
    }
    
    const stageProgress = document.querySelector('.progress-bar.bg-info');
    if (stageProgress) {
        stageProgress.style.width = `${data.stage_progress}%`;
        stageProgress.textContent = `${data.stage_progress}% complete`;
    }
    
    // Update text labels
    const progressLabel = document.querySelector('.progress-label');
    if (progressLabel && data.total_raw_results > 0) {
        progressLabel.textContent = `${data.progress_percentage}% (${data.processed_count}/${data.total_raw_results} results)`;
    }
    
    // Update current stage
    const stageInfo = document.querySelector('.current-stage-info h6');
    if (stageInfo && data.current_stage) {
        stageInfo.textContent = `Current Stage: ${data.current_stage.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}`;
    }
}

function getAuthToken() {
    // Return authentication token for API calls
    // This would typically be stored in a cookie or localStorage
    return document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

function pauseProcessing() {
    // Implement pause functionality
    alert('Pause functionality will be implemented in future version');
}

function cancelProcessing() {
    if (confirm('Are you sure you want to cancel processing? This cannot be undone.')) {
        // Implement cancel functionality
        alert('Cancel functionality will be implemented in future version');
    }
}

function viewAllErrors() {
    // Show modal with all error details
    alert('View all errors functionality will be implemented in future version');
}
</script>
{% endblock %}